<!DOCTYPE html>
<html>
<head>
<title>Song Editor</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
.editor {}
.board {
	display: flex;
	overflow: scroll;
	padding-bottom: 14px;
}
.column {
	padding: 0px 0px;
	border-right: 1px solid #ddd;
	transition: all 0.2s;
}
.column:hover {
	background: #fafafa;
}
.column--highlighted {
	background: #eee;
}
.column-button-container {}
.column-button {
	cursor: pointer;
	width: 100%;
	box-sizing: border-box;
}
.note-name {
	display: block;
	padding: 0px 8px;
	border-radius: 3px;
	cursor: pointer;
	transition: all 0.2s;
	font-size: 15px;
	white-space: nowrap;
	box-sizing: border-box;
	width: 50px;
}
.note-name-checkbox {
	position: absolute;
	left: -99999px;
	opacity: 0;
	pointer-events: none;
}
.note-name-checkbox:checked + .note-name {
	background: gold;
}
.note-name:hover {
	background: #0098db;
}
.controls {
	background-color: #fff;
	position: sticky;
	bottom: 0;
	padding: 10px 0px;
}
#exporter {
	position: absolute;
	left: -9999999px;
}
input[type="number"] {
	width: 50px;
}
</style>
</head>
<body>

<div class="editor">
</div>
<div class="controls">
	<button class="play">Play</button>
	<button class="pause">Pause</button>
	<button class="stop">Stop</button>
	<button class="clear">Clear</button>
	<button class="export">Export</button>
	<div>
		Note duration:
		<input type="number" class="note-duration" value="1" step="0.5" min="0" autocomplete="off">
		Seconds per beat:
		<input type="number" class="seconds-per-beat" value="0.2" step="0.05" min="0.05" autocomplete="off">
		Song length (in beats):
		<input type="number" class="song-length" value="50" step="1" min="1" autocomplete="off">
	</div>
	<div>
		Sample songs:
		<button class="sample-minuet">Minuet in G</button>
		<button class="sample-smash">Smash</button>
		<button class="sample-smash-extra">Smash Extra</button>
		<button class="sample-big-shot">Big Shot</button>
	</div>
</div>


<textarea id="exporter"></textarea>

<script src="./scripts/Tone.js"></script>
<script src="./songs/minuetInG.js"></script>
<script src="./songs/smash.js"></script>
<script src="./songs/smashExtra.js"></script>
<script src="./songs/bigShot.js"></script>
<script>



function buildEditor(container) {
	const board = createBoard();

	let currentBeat = 0;
	let secondsPerBeat = 0.2;
	let interval;
	let beatCount = 50;
	let octaves = [5, 4, 3, 2];
	let songBeats = restBeats(beatCount);
	let noteDuration = 1;
	let columnNodes;

	const sampler = new Tone.Sampler({
		urls: {
			"A5": "A5.mp3",
			"C4": "C4.mp3",
			"D#4": "Ds4.mp3",
			"F#4": "Fs4.mp3",
			"A4": "A4.mp3",
			"C3": "C3.mp3",
			"C2": "C2.mp3",
		},
		release: 1,
		baseUrl: "https://tonejs.github.io/audio/salamander/",
	}).toDestination();

	const notes = [
		'C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'Bb', 'B',
	].reverse();

	function scrollToBeat(beatNumber) {
		const columnWidth = 50;
		const offset = 2;
		const boardWidth = board.getBoundingClientRect().width;
		const columnsPerPage = Math.floor(boardWidth / columnWidth - offset);
		if (beatNumber % columnsPerPage === 0) {
			board.scrollTo({
				left: beatNumber * columnWidth,
			});
		}
	}

	function updateSongLength(newBeatCount) {
		if (newBeatCount > beatCount) {
			extendSong(newBeatCount);
		}
		else if (newBeatCount < beatCount) {
			shortenSong(newBeatCount);
		}
	}

	function extendSong(newBeatCount) {
		const extraBeats = newBeatCount - beatCount;
		songBeats = [...songBeats, ...restBeats(extraBeats)];
		setSong({secondsPerBeat, beats: songBeats});
	}

	function shortenSong(newBeatCount) {
		const beatsToRemove = beatCount - newBeatCount;
		songBeats = songBeats.slice(0, -beatsToRemove);
		setSong({secondsPerBeat, beats: songBeats});
	}

	function restBeats(beats) {
		return Array(beats).fill().map(item => [ { notes: [], durationInBeats: 1 }, ]);
	};

	function createBoard() {
		const board = document.createElement('div');
		board.classList.add('board');
		container.appendChild(board);
		return board;
	}

	function renderBoard({ columnCount }) {
		board.innerHTML = '';
		appendColumnsToBoard(columnCount);
		storeLatestColumnNodes();
	}

	function storeLatestColumnNodes() {
		columnNodes = board.querySelectorAll('.column');
	}

	function appendColumnsToBoard(columnCount) {
		const fragment = new DocumentFragment();
		for (let i=0; i<columnCount; i++) {
			const column = buildColumn(notes, i);
			fragment.appendChild(column);
		}
		board.appendChild(fragment);
	}

	function clearSong() {
		resetSongBeats();
		uncheckAllCheckboxes();
		resetAllNoteNames();
	}

	function resetSongBeats() {
		songBeats = restBeats(songBeats.length);
	}

	function uncheckAllCheckboxes() {
		board.querySelectorAll('.note-name-checkbox').forEach(checkbox => {
			checkbox.checked = false;
		});
	}

	function resetAllNoteNames() {
		board.querySelectorAll('.note-name').forEach(noteNameContainer => {
			const noteNameWithoutDuration = noteNameContainer.innerText.split('(')[0];
			noteNameContainer.innerText = noteNameWithoutDuration; 
		});
	}

	function buildColumn(notes, columnNumber) {
		const column = generateColumnHtml(columnNumber);

		placeNotesInColumn(notes, column);
		placeColumnButton(column);

		return column;
	}

	function generateColumnHtml(columnNumber) {
		const column = document.createElement('div');
		column.classList.add('column');
		column.dataset.columnNumber = columnNumber;
		return column;
	}

	function placeNotesInColumn(notes, column) {
		octaves.forEach(octave => {
			placeNotesInOctave(notes, column, octave);
		});
	}

	function placeNotesInOctave(notes, column, octave) {
		const { columnNumber } = column.dataset;
		notes.forEach(note => {
			const noteButton = buildNoteButton(note, columnNumber, octave);
			column.appendChild(noteButton);
		});
	}

	function buildColumnButton(columnNumber) {
		const columnButtonContainer = document.createElement('div');
		columnButtonContainer.classList.add('column-button-container');
		const columnButton = document.createElement('button');
		columnButton.innerText = columnNumber;
		columnButton.addEventListener('click', () => {
			goToBeat(columnNumber);
		});
		columnButton.classList.add('column-button');
		columnButtonContainer.appendChild(columnButton);
		return columnButtonContainer;
	}

	function buildNoteButton(note, beatNumber, octave) {
		const noteButton = generateNoteButtonHtml(note, beatNumber, octave);
		const checkbox = noteButton.querySelector('input');
		const noteNameContainer = noteButton.querySelector('.note-name');

		checkbox.addEventListener('change', function() {
			toggleNoteCheckbox(checkbox, noteNameContainer);
		});
		return noteButton;
	}

	function placeColumnButton(column) {
		const { columnNumber } = column.dataset;
		const columnButton = buildColumnButton(columnNumber);
		column.appendChild(columnButton);
	}

	function generateNoteButtonHtml(note, beatNumber, octave) {
		const noteButton = document.createElement('div');
		noteButton.classList.add('note-button');
		noteButton.innerHTML = `
			<label>
				<input class="note-name-checkbox" type="checkbox" value="${note}${octave}" data-beat-number="${beatNumber}" data-note-name="${note}" data-selected-duration="1">
				<span class="note-name">${note}</span>
			</label>
		`;
		return noteButton;
	}

	const toggleNoteCheckbox = (checkbox, noteNameContainer) => {
		const { beatNumber, noteName } = checkbox.dataset;
		const beat = songBeats[beatNumber];
		const changedNote = checkbox.value;

		playChord([changedNote], noteDuration);

		if (checkbox.checked) {
			checkNoteCheckbox(checkbox, noteNameContainer);
		}
		else {
			uncheckNoteCheckbox(checkbox, noteNameContainer);
		}
	}

	function checkNoteCheckbox(checkbox, noteNameContainer) {
		const { beatNumber, noteName } = checkbox.dataset;
		const beat = songBeats[beatNumber];
		const changedNote = checkbox.value;
		const currentChord = getCurrentChord(beat, noteDuration);
		const existingNotes = [...beat[currentChord].notes];
		beat[currentChord].notes = deduplicate([...existingNotes, changedNote]);
		beat[currentChord].durationInBeats = noteDuration;
		checkbox.dataset.selectedDuration = noteDuration;
		noteNameContainer.innerText = `${noteName}(${noteDuration})`;
	}

	function uncheckNoteCheckbox(checkbox, noteNameContainer) {
		const { beatNumber, noteName, selectedDuration } = checkbox.dataset;
		const beat = songBeats[beatNumber];
		const changedNote = checkbox.value;
		const currentChord = getCurrentChord(beat, selectedDuration);
		const existingNotes = [...beat[currentChord].notes];
		beat[currentChord].notes = existingNotes.filter(note => note !== changedNote);
		songBeats[beatNumber] = removeEmptyNonRestChords(beat);
		noteNameContainer.innerText = noteName;
	}

	function deduplicate(array) {
		return Array.from(new Set(array));
	}

	function getCurrentChord(beat, duration) {
		let index = beat.findIndex(chord => chord.durationInBeats === Number(duration));
		const indexNotFound = index === -1;
		if (indexNotFound) {
			addBlankChord(beat);
			index = beat.length - 1;
		}
		return index;
	}

	function addBlankChord(beat) {
		beat.push({ notes: [], durationInBeats: noteDuration });
	}

	function removeEmptyNonRestChords(beat) {
		const isChordNeeded = (chord) => ( chord.durationInBeats === 1 || chord.notes.length !== 0 );
		return beat.filter(isChordNeeded);
	}

	function setSong(importedSong) {
		clearSong();
		const copyOfSong = JSON.parse(JSON.stringify(importedSong));
		setTempo(copyOfSong.secondsPerBeat);
		beatCount = copyOfSong.beats.length;

		renderBoard({ columnCount: copyOfSong.beats.length });
		copyOfSong.beats.forEach((beat, i) => {
			songBeats[i] = beat;
		});

		songBeats.forEach((beat, beatNumber) => {
			prepareBeat(beat, beatNumber, columnNodes);
		});
	}

	function prepareBeat(beat, beatNumber, columns) {
		const currentColumn = columns[beatNumber];
		beat.forEach(chord => {
			setChord(chord, currentColumn);
		});
	}

	function setChord(chord, currentColumn) {
		chord.notes.forEach(note => {
			updateNoteButton(note, chord, currentColumn);
		});
	}

	function updateNoteButton(note, chord, currentColumn) {
		const checkbox = currentColumn.querySelector(`[value="${note}"]`);
		const label = currentColumn.querySelector(`[value="${note}"] + .note-name`);
		const noteName = note.replace(/\d+/g, '');
		const duration = chord.durationInBeats;
		checkbox.checked = true;
		checkbox.dataset.selectedDuration = duration;
		label.innerText = `${noteName}(${duration})`;
	}

	function setTempo(tempo) {
		secondsPerBeat = tempo;
		document.querySelector('.seconds-per-beat').value = tempo;
	}

	function exportToClipboard() {
		const exporter = document.querySelector('#exporter');
		exporter.innerHTML = JSON.stringify({ secondsPerBeat, beats: songBeats }, null, '\t');
		exporter.select();
		document.execCommand('copy');
	}

	function clearHighlightedColumn() {
		board.querySelector('.column--highlighted')?.classList.remove('column--highlighted');
	}

	function highlightColumn(n) {
		clearHighlightedColumn();
		columnNodes[n].classList.add('column--highlighted');
	}

	function play() {
		clearInterval(interval);
		interval = setInterval(playNextBeat, secondsPerBeat * 1000);
	}

	function playNextBeat() {
		songBeats[currentBeat].forEach(chord => {
			const { notes, durationInBeats } = chord;
			playChord(notes, durationInBeats);
		});
		highlightColumn(currentBeat);
		scrollToBeat(currentBeat);

		currentBeat++;

		if (currentBeat >= songBeats.length) {
			stop();
		}
	}

	function pause() {
		clearInterval(interval);
	}
	function stop() {
		clearInterval(interval);
		clearHighlightedColumn();
		currentBeat = 0;
	}
	function goToBeat(n) {
		highlightColumn(n);
		currentBeat = n;
	}
	function playChord(notes, beats) {
		sampler.triggerAttackRelease(notes, beats * secondsPerBeat);
	}

	function attachListeners() {
		document.querySelector('.play').addEventListener('click', () => {
			play();
		});
		document.querySelector('.pause').addEventListener('click', () => {
			pause();
		});
		document.querySelector('.stop').addEventListener('click', () => {
			stop();
		});
		document.querySelector('.clear').addEventListener('click', () => {
			const confirmation = confirm('Are you sure you want to erase the song?');
			if (confirmation) { clearSong(); }
		});
		document.querySelector('.export').addEventListener('click', function() {
			exportToClipboard();
			this.innerText = 'Copied!';
			setTimeout(() => { this.innerText = 'Export'; }, 1000);
		});
		document.querySelector('.note-duration').addEventListener('input', function() {
			noteDuration = Number(this.value);
		});
		document.querySelector('.seconds-per-beat').addEventListener('input', function() {
			secondsPerBeat = Number(this.value);
		});
		document.querySelector('.song-length').addEventListener('change', function() {
			updateSongLength(this.value);
		});
		document.querySelector('.sample-minuet').addEventListener('click', function() {
			setSong(minuetInG);
		});
		document.querySelector('.sample-smash').addEventListener('click', function() {
			setSong(smash);
		});
		document.querySelector('.sample-smash-extra').addEventListener('click', function() {
			setSong(smashExtra);
		});
		document.querySelector('.sample-big-shot').addEventListener('click', function() {
			setSong(bigShot);
		});
	}

	function getSongBeats() {
		return songBeats;
	}

	function init() {
		renderBoard({ columnCount: beatCount });
		attachListeners();
	}

	init();

	return {
		getSongBeats,
		setSong,
		clearSong,
		play,
		pause,
		stop,
		goToBeat,
	};
}

const editor = buildEditor(document.querySelector('.editor'));
editor.setSong(minuetInG);

</script>
</body>
</html>